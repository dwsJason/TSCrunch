# TSCrunch

About
=====

TSCrunch is an optimal, byte-aligned, LZ+RLE hybrid encoder, designed to maximize decoding speed on NMOS 6502 and derived CPUs, while keeping decent compression performance (for a bytecruncher, that is).
TSCrunch was designed as the default asset cruncher for the game A Pig Quest, and, as such, it's optimized for in-memory level compression, but as of version 1.0 it can also create SFX executables for off-line prg crunching.

Requirements
============

TSCrunch is written in GO and therefore should run on any machine that supports a go compiler.
Precompiled binaries are available for the following platforms:
- windows x64
- windows arm64
- linux x64
- mac / darwin arm64

A python version is also supplied as reference encoder, but use of GO version is recommended for speed. 
The memory decrunchers requires Kick Assembler, but it should be quite easy to port them to your assembler of choice.

Usage
=====

tscrunch [option] infile outfile

Crunching examples:

	tscrunch -x $0820 game.prg crunched.prg
	
Crunches the file game.prg and generates a self executable crunched.prg, using $0820 as post-decrunch jmp address

	tscrunch -p game.prg crunched.bin

Mem-crunches the file game.prg, stripping the 2-byte header and generates a binary file crunched.bin

	tscrunch data.bin crunched.bin
Mem-crunches the file data.bin and generates a binary file crunched.bin

	tscrunch -i data.prg crunched.prg
Mem-crunches the file data.bin for in-place use, and generates a prg file crunched.prg with the appropriate load address

	tscrunch -x2 49152 game.prg crunched.prg
	
Crunches the file game.prg and generates a self executable crunched.prg with alternative decrunching code, using $c000 (49152) as post-decrunch jmp address. The alternative decrunching code runs from stack instead of zero-page

	tscrunch -x 0x1000 -b game.prg crunched.prg
	
Crunches the file game.prg and generates a self executable crunched.prg that blank the screen while decrunching, using $1000 (0x1000) as post-decrunch jmp address.


Please refer to the inline help (tscrunch -h) for a detailed description of the different crunching options.
Note that with the exception of self executables and in-place, all the files generated by TSCrunch are headless binaries, that is they don't come with a 2 byte loader offset.

Decrunching files from code
===========================

For memory decrunching, please #include decrunch.asm and include the crunched binaries in your code, then use the macro TS_DECRUNCH, as explained by the following code fragment 

		.pc = $1000 "test"
		//decrunches data to $4000
		:TS_DECRUNCH(compressed_data,$4000) 
		jmp *

		.align $100
		#include "decrunch.asm"
		
		compressed_data:
		.import binary "data.bin"
		

For inplace decrunching, please #define INPLACE before including the decruncher code, as explained by the following code fragment

		#define INPLACE

		.pc = $1000 "test"
		//decrunches data inplace
		:TS_DECRUNCH(compressed_data) 
		jmp *

		.align $100
		#include "decrunch.asm"
		
		.pc = LoadAddress //as provided by the cruncher
		compressed_data:
		.import c64 "data.bin"


decruncher.asm is the recommended decruncher for the general case, but other than it two alternative decrunchers are supplied: a small version, which saves some bytes at the cost of speed, and an extreme version which is generally marginally faster, but comes with a larger footprint. 


Performance
===========

TSCrunch is designed for ultra-fast decrunching while keeping a decent compression ratio. Being a byte-cruncher, it falls short of popular bit-crunchers, such as exomizer or B2, when comparing compression efficiency, but it is usually much faster at decoding. Furthermore, you can expect a 20% to 40% speed bump compared to popular byte-crunchers with similar compression efficiency.
The following benchmark compares TSCrunch performance with those of a fast byte-cruncher, TinyCrunch, and a two fast bit-crunchers, B2 and dali, on a real-case compression scenario: Chopper Command, from the same author.

![benchmark](https://user-images.githubusercontent.com/52791690/161444947-1e01a5b1-f89d-4ef1-bd17-54d563cdd670.png)


